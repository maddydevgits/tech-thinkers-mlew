{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2" data-translate="search_products_title">Search Products</h1>
        <p class="text-gray-600" data-translate="search_products_desc">Find pesticides and fertilizers for your crops</p>
    </div>

    <!-- Search Form -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <form method="GET" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="q" class="block text-sm font-medium text-gray-700 mb-2" data-translate="search_by_name">
                        Search by Product Name
                    </label>
                    <input type="text" id="q" name="q" value="{{ query }}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500"
                        placeholder="e.g., Roundup, Fertilizer" data-translate-placeholder="search_placeholder">
                </div>

                <div>
                    <label for="crop_type" class="block text-sm font-medium text-gray-700 mb-2" data-translate="filter_by_crop">
                        Filter by Crop Type
                    </label>
                    <select id="crop_type" name="crop_type"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option value="" data-translate="all_crops">All Crops</option>
                        <option value="Rice" {% if crop_type == 'Rice' %}selected{% endif %}>Rice</option>
                        <option value="Wheat" {% if crop_type == 'Wheat' %}selected{% endif %}>Wheat</option>
                        <option value="Corn" {% if crop_type == 'Corn' %}selected{% endif %}>Corn</option>
                        <option value="Soybean" {% if crop_type == 'Soybean' %}selected{% endif %}>Soybean</option>
                        <option value="Cotton" {% if crop_type == 'Cotton' %}selected{% endif %}>Cotton</option>
                        <option value="Sugarcane" {% if crop_type == 'Sugarcane' %}selected{% endif %}>Sugarcane</option>
                        <option value="Tomato" {% if crop_type == 'Tomato' %}selected{% endif %}>Tomato</option>
                        <option value="Potato" {% if crop_type == 'Potato' %}selected{% endif %}>Potato</option>
                        <option value="Onion" {% if crop_type == 'Onion' %}selected{% endif %}>Onion</option>
                        <option value="Chili" {% if crop_type == 'Chili' %}selected{% endif %}>Chili</option>
                        <option value="General" {% if crop_type == 'General' %}selected{% endif %}>General Use</option>
                    </select>
                </div>

                <div class="flex items-end">
                    <button type="submit"
                        class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md font-medium transition duration-300">
                        <i class="fas fa-search mr-2"></i><span data-translate="search">Search</span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Search Results -->
    {% if products %}
        <div class="mb-4">
            <p class="text-gray-600" data-translate="found_products">
                Found {{ products|length }} product{{ 's' if products|length != 1 else '' }}
                {% if query or crop_type %}
                    <span data-translate="matching_criteria">matching your search criteria</span>
                {% endif %}
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for product in products %}
            <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition duration-300">
                <!-- Product Image -->
                {% if product.image_filename %}
                <div class="h-48 bg-gray-200 rounded-t-lg overflow-hidden">
                    <img src="{{ url_for('uploaded_file', filename=product.image_filename) }}" 
                         alt="{{ product.name }}" 
                         class="w-full h-full object-cover hover:scale-105 transition-transform duration-300">
                </div>
                {% else %}
                <div class="h-48 bg-gray-200 rounded-t-lg flex items-center justify-center">
                    <i class="fas fa-image text-gray-400 text-4xl"></i>
                </div>
                {% endif %}
                
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-900" data-translate="product_name_{{ loop.index }}">{{ product.name }}</h3>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" data-translate="crop_type_{{ loop.index }}">
                            {{ product.crop_type }}
                        </span>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-1" data-translate="specifications">Specifications:</h4>
                            <p class="text-sm text-gray-600" data-translate="specifications_{{ loop.index }}">{{ product.specifications[:100] }}{% if product.specifications|length > 100 %}...{% endif %}</p>
                        </div>

                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-1" data-translate="active_chemicals">Active Chemicals:</h4>
                            <p class="text-sm text-gray-600" data-translate="chemicals_{{ loop.index }}">{{ product.chemicals[:80] }}{% if product.chemicals|length > 80 %}...{% endif %}</p>
                        </div>

                        <div class="flex justify-between items-center pt-3 border-t border-gray-200">
                            <div>
                                <span class="text-2xl font-bold text-green-600">â‚¹{{ "%.2f"|format(product.cost) }}</span>
                                <span class="text-sm text-gray-500" data-translate="per_unit">per unit</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600" data-translate="available">Available:</div>
                                <div class="font-medium text-gray-900" data-translate="units_{{ loop.index }}">{{ product.quantity }} units</div>
                            </div>
                        </div>

                        <div class="pt-3">
                            <div class="flex justify-between items-center text-sm text-gray-500 mb-3">
                                <span><i class="fas fa-store mr-1"></i>{{ product.shop_name }}</span>
                                <span><i class="fas fa-calendar mr-1"></i>{{ product.created_at.strftime('%d %b %Y') }}</span>
                            </div>
                            
                            <!-- Order Now Button -->
                            {% if session.user_id and session.user_type == 'farmer' %}
                            <div class="flex justify-center">
                                <button onclick="openOrderModal('{{ product._id }}', '{{ product.name }}', {{ product.cost }}, {{ product.quantity }}, '{{ product.shop_name }}')" 
                                        class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition duration-300 flex items-center justify-center">
                                    <i class="fas fa-shopping-cart mr-2"></i>
                                    <span data-translate="order_now">Order Now</span>
                                </button>
                            </div>
                            {% elif not session.user_id %}
                            <div class="flex justify-center">
                                <a href="{{ url_for('login') }}" 
                                   class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition duration-300 flex items-center justify-center">
                                    <i class="fas fa-sign-in-alt mr-2"></i>
                                    <span data-translate="login_to_order">Login to Order</span>
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-12 bg-white rounded-lg shadow">
            <i class="fas fa-search text-gray-400 text-6xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2" data-translate="no_products_found">No products found</h3>
            <p class="text-gray-500 mb-6" data-translate="no_products_message">
                {% if query or crop_type %}
                    <span data-translate="try_adjusting">Try adjusting your search criteria or browse all products.</span>
                {% else %}
                    <span data-translate="no_products_available">No products are available yet. Check back later!</span>
                {% endif %}
            </p>
            {% if query or crop_type %}
                <a href="{{ url_for('search') }}" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition duration-300" data-translate="view_all_products">
                    View All Products
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Order Modal -->
<div id="orderModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" data-translate="place_order">Place Order</h3>
                <button onclick="closeOrderModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="orderForm" method="POST" action="{{ url_for('place_order') }}">
                <input type="hidden" id="productId" name="product_id">
                
                <div class="space-y-4">
                    <!-- Product Info -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800" data-translate="product_details">Product Details</h4>
                        <div class="mt-2">
                            <p class="text-sm text-gray-600"><span data-translate="product_name">Product:</span> <span id="productName"></span></p>
                            <p class="text-sm text-gray-600"><span data-translate="shop_name">Shop:</span> <span id="shopName"></span></p>
                            <p class="text-sm text-gray-600"><span data-translate="price_per_unit">Price:</span> â‚¹<span id="productPrice"></span> <span data-translate="per_unit">per unit</span></p>
                            <p class="text-sm text-gray-600"><span data-translate="available_quantity">Available:</span> <span id="availableQuantity"></span> <span data-translate="units">units</span></p>
                        </div>
                    </div>
                    
                    <!-- Quantity -->
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2" data-translate="order_quantity">Order Quantity *</label>
                        <input type="number" id="quantity" name="quantity" min="1" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500"
                               placeholder="Enter quantity">
                    </div>
                    
                    <!-- Delivery Address -->
                    <div>
                        <label for="delivery_address" class="block text-sm font-medium text-gray-700 mb-2" data-translate="delivery_address">Delivery Address *</label>
                        <textarea id="delivery_address" name="delivery_address" rows="3" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500"
                                  placeholder="Enter your complete delivery address" data-translate-placeholder="address_placeholder"></textarea>
                    </div>
                    
                    <!-- Contact Number -->
                    <div>
                        <label for="contact_number" class="block text-sm font-medium text-gray-700 mb-2" data-translate="contact_number">Contact Number *</label>
                        <input type="tel" id="contact_number" name="contact_number" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500"
                               placeholder="Enter your contact number" data-translate-placeholder="contact_placeholder">
                    </div>
                    
                    <!-- Order Notes -->
                    <div>
                        <label for="order_notes" class="block text-sm font-medium text-gray-700 mb-2" data-translate="order_notes">Order Notes (Optional)</label>
                        <textarea id="order_notes" name="order_notes" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500"
                                  placeholder="Any special instructions or notes" data-translate-placeholder="notes_placeholder"></textarea>
                    </div>
                    
                    <!-- Total Price -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-800" data-translate="total_amount">Total Amount:</span>
                            <span class="text-2xl font-bold text-green-600">â‚¹<span id="totalAmount">0.00</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeOrderModal()" 
                            class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300" data-translate="cancel">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500" data-translate="place_order">
                        <i class="fas fa-shopping-cart mr-2"></i>Place Order
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openOrderModal(productId, productName, productPrice, availableQuantity, shopName) {
    document.getElementById('productId').value = productId;
    document.getElementById('productName').textContent = productName;
    document.getElementById('productPrice').textContent = productPrice.toFixed(2);
    document.getElementById('availableQuantity').textContent = availableQuantity;
    document.getElementById('shopName').textContent = shopName;
    
    // Set max quantity
    document.getElementById('quantity').max = availableQuantity;
    
    // Reset form
    document.getElementById('quantity').value = '';
    document.getElementById('delivery_address').value = '';
    document.getElementById('contact_number').value = '';
    document.getElementById('order_notes').value = '';
    document.getElementById('totalAmount').textContent = '0.00';
    
    document.getElementById('orderModal').classList.remove('hidden');
}

function closeOrderModal() {
    document.getElementById('orderModal').classList.add('hidden');
}

// Calculate total amount when quantity changes
document.getElementById('quantity').addEventListener('input', function() {
    const quantity = parseInt(this.value) || 0;
    const price = parseFloat(document.getElementById('productPrice').textContent) || 0;
    const total = quantity * price;
    document.getElementById('totalAmount').textContent = total.toFixed(2);
});

// Close modal when clicking outside
document.getElementById('orderModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeOrderModal();
    }
});
</script>
{% endblock %}
